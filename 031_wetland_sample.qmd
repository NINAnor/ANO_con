# Wetland samples

Now we go on to create the actual samples for ANO v√•tmark (wetlands), using `spaceR::nested_balanced_samples`.


```{r setup_sample}
#| include: false
#| message: false
#| error: false
library(tidyverse)
library(dbplyr)
library(DBI)
library(RPostgres)
library(dm)
library(spaceR)
```

## Get and prepare sampling frame
First we need to fetch the samping frame from the database.
```{r viewData}
#| include: true
#| eval: true
con <- DBI::dbConnect(drv = RPostgres::Postgres(), host = "t2lippgsql03", dbname = "ano_moduler")

wet_sample <- dplyr::tbl(con, dbplyr::in_schema("sampling_frames", "samplingframe_vaatmark_2025")) |>
  dplyr::collect()

small <- function(data = wet_sample) data |>  slice_sample(n = 10000)
```

This dataset (sampling frame) is `r nrow(wet_sample)` long. @tbl-sf show just the first ten rows. We have two spreading variables: an easting `centroid_x`, a northing `centroid_y`. We also have sampling unit ID's in `ssbid`, and two auxiliary variable for balancing: `mean_slope` and `abi`. The stratification variable we need to create based on `seksjon_kode` and `sone_kode`. We also need to create an `area` variable based on the sum of `r_hav` and `r_ferskvann`. 

```{r tbl-sf}
#| include: true
wet_sample |>
  slice_head(n = 10) |>
  DT::datatable()
```

```{r datacheck}
#| eval: false
summary(wet_sample$r_ferskvann)
summary(wet_sample$r_hav)
dotchart(wet_small$r_ferskvann)
dotchart(wet_small$r_hav)
dotchart(wet_small$centroid_x)
dotchart(wet_small$centroid_y)
dotchart(wet_small$ost)
dotchart(wet_small$nord)

dotchart(wet_small$mean_slope)
dotchart(wet_small$abi)

```

```{r makeVars}
#| eval: true
# the northing numbers are very large 
minN <- min(wet_sample$centroid_y)

wet_sample <- wet_sample |>
  rename(Northing = nord,
         Easting = ost) |>
  mutate(area = 100 - r_hav - r_ferskvann,
         Northing = Northing - minN,
         stratum = case_when(
           seksjon_kode %in% c("6SE-3", "6SE-4", "6SE-5") & sone_kode %in% c("6SO-1", "6SO-2") ~  1,
           seksjon_kode %in% c("6SE-2") & sone_kode %in% c("6SO-1", "6SO-2") ~  2,
           seksjon_kode %in% c("6SE-1") & sone_kode %in% c("6SO-1", "6SO-2") ~  3,
           seksjon_kode %in% c("6SE-1") & sone_kode %in% c("6SO-3", "6SO-4", "6SO-5") ~  4,
           seksjon_kode %in% c("6SE-2") & sone_kode %in% c("6SO-3") ~  5,
           seksjon_kode %in% c("6SE-2") & sone_kode %in% c("6SO-4", "6SO-5") ~  6,
           seksjon_kode %in% c("6SE-3", "6SE-4", "6SE-5") & sone_kode %in% c("6SO-3") ~  7,
           seksjon_kode %in% c("6SE-3", "6SE-4") & sone_kode %in% c("6SO-4", "6SO-5") ~  8,
           seksjon_kode %in% c("6SE-5") & sone_kode %in% c("6SO-4", "6SO-5") ~  9,
           .default = 99
           ))

wet_small <- small()
```

There is a problem with NAs in the bioclimatic sones and regions:
```{r}
#| eval: true
wet_sample |>
  group_by(stratum) |>
  summarise(n = n())
```

We have `r nrow(wet_sample[wet_sample$stratum == 99,])` population units that we don't know the strata for. Lets see if there is a pettern in where these units are found. This first check tells us that stratum 99 is a consequence of NA's on both the sone and section. Then @fig-dots tells us that the population units where we lack data on biocliatic regions are mainly along the coast (a lot of ocean), but also close to freshwater. This isa problem, as it will lead to undersampling of areas close to water.
However, we cannot solve this now, and rumors have it that the bioclimatic zone and regions dataset will get updated very soon, so then we can also update (rerun) the sampling pipeline.

The same problem seems to also be for `abi`, that we have false zero values along the coast or along water. We know this from visial checks, but also from @fig-dots where we see that `abi` is always zero, at the same time that `r_bebygd_samf` is not.
```{r}
#| eval: true
wet_sample |>
  filter(stratum == 99) |>
  tidyr::unite(combo, c(seksjon_kode, sone_kode)) |>
  distinct(combo)
```

```{r fig-dots}
#| eval: true
#| message: false
#| fig-cap: 'Distrbutions for selected variables for whick we lack data on stratum (bioclimatic region).' 
wet_sample |>
  filter(stratum == 99) |>
  pivot_longer(cols = c(r_hav, r_ferskvann, abi, mean_slope, r_bebygd_samf, r_sno_isbre)) |>
  ggplot()+
  geom_dotplot(aes(value))+
  facet_wrap(.~name)+
  theme_bw()

```

## Sample

```{r stripdata}
#| eval: true

wet_sample <- wet_sample |>
  select(ssbid, Easting = ost, Northing = nord, area, abi, mean_slope, stratum)

wet_sample <- wet_sample |>
  filter(stratum != 99)

wet_small <- small()
```

```{r}
testRun <- spaceR::nested_balanced_samples(
  samplingFrame = wet_small,
  n_seq = seq(50, 10, -10),
  id_col = "ssbid",
  stratum_col = "stratum",
  easting_col = "Easting",
  northing_col = "Northing",
  area_col = "area",
  xbal_formula = ~ abi + mean_slope -1,
  exclude_offset = 1e+09,
  return_indices = TRUE
)
```


